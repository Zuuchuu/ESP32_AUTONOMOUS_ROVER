<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Rover Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    <style>
        #map { 
            height: 100vh; 
            width: 100%;
            margin: 0;
            padding: 0;
        }
        .map-control-bar {
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            padding: 6px 8px;
            display: flex;
            gap: 6px;
            align-items: center;
            max-width: 420px;
        }
        .map-control-bar button {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 6px 10px;
            background: #fff;
            cursor: pointer;
        }
        .map-control-bar button:hover { background: #f3f3f3; }
        body {
            margin: 0;
            padding: 0;
        }
        .waypoint-popup {
            font-family: Arial, sans-serif;
            font-size: 12px;
        }
        .rover-popup {
            font-family: Arial, sans-serif;
            font-size: 12px;
            font-weight: bold;
            color: #d63031;
        }
        .waypoint-number-label {
            background-color: #2196F3;
            border: 1px solid white;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .waypoint-label-text {
            color: white;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
            line-height: 18px;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="map-control-bar" id="mapTopControls">
        <button id="btnCenter">Center on Rover</button>
        <button id="btnFit">Fit All</button>
        <button id="btnFollow">Resume Follow</button>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script>
        // Initialize map with default view (can be changed via Python)
        var map = L.map('map').setView([37.7749, -122.4194], 13); // San Francisco default
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Arrays to store waypoints and markers
        var waypoints = [];
        var waypointMarkers = [];
        var roverMarker = null;
        var autoFollow = true;
        var waypointCounter = 1;
        
        // Custom icons
        var waypointIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        
        var roverIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        
        // Map click handler to add waypoints
        map.on('click', function(e) {
            if (waypoints.length < 10) {
                addWaypointAtPosition(e.latlng.lat, e.latlng.lng);
            } else {
                console.log('Maximum of 10 waypoints allowed');
            }
        });

        // Detect manual pan/zoom to pause auto-follow
        map.on('movestart', function() { autoFollow = false; });
        
        // Function to add waypoint at specific coordinates
        function addWaypointAtPosition(lat, lng) {
            if (waypoints.length >= 10) {
                console.log('Cannot add waypoint: Maximum of 10 waypoints reached');
                return false;
            }
            
            var latlng = L.latLng(lat, lng);
            
            // Use the original blue marker icon
            var marker = L.marker(latlng, {icon: waypointIcon}).addTo(map);
            
            // Add popup with waypoint info including the number
            marker.bindPopup(`<div class="waypoint-popup">
                <strong>Waypoint ${waypointCounter}</strong><br>
                Lat: ${lat.toFixed(6)}<br>
                Lng: ${lng.toFixed(6)}
            </div>`);
            
            // Add a number label above the marker
            // Create a composite marker icon: blue pin with number overlay
            var numberHtml = `<div style="position: relative; width: 25px; height: 41px;">
                <img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png" width="25" height="41"/>
                <div style="position: absolute; top: 0; left: 0; width: 25px; height: 41px; display: flex; align-items: center; justify-content: center;">
                    <span style="color: white; font-weight: bold; font-size: 12px; text-shadow: 0 1px 2px rgba(0,0,0,0.4);">${waypointCounter}</span>
                </div>
            </div>`;
            var numberedIcon = L.divIcon({
                className: 'waypoint-numbered-icon',
                html: numberHtml,
                iconSize: [25, 41],
                iconAnchor: [12, 41]
            });

            // Replace default icon with composite icon
            marker.setIcon(numberedIcon);

            waypointMarkers.push(marker);
            waypoints.push({lat: lat, lng: lng, id: waypointCounter});
            waypointCounter++;
            
            console.log(`Added waypoint ${waypoints.length}: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
            return true;
        }
        
        // Function to get all waypoints (called from Python)
        function getWaypoints() {
            return waypoints.map(function(wp) { 
                return {lat: wp.lat, lng: wp.lng}; 
            });
        }
        
        // Function to clear all waypoints
        function clearWaypoints() {
            waypointMarkers.forEach(function(marker) { 
                map.removeLayer(marker); 
            });
            waypointMarkers = [];
            waypoints = [];
            waypointCounter = 1;
            console.log('All waypoints cleared');
        }
        
        // Function to add waypoint programmatically (called from Python)
        function addWaypoint(lat, lng) {
            return addWaypointAtPosition(lat, lng);
        }
        
        // Function to set rover position
        function setRoverPosition(lat, lng, heading) {
            if (roverMarker) {
                roverMarker.setLatLng([lat, lng]);
            } else {
                roverMarker = L.marker([lat, lng], {icon: roverIcon}).addTo(map);
            }
            
            // Update rover popup with current info
            var popupContent = `<div class="rover-popup">
                <strong>ESP32 Rover</strong><br>
                Lat: ${lat.toFixed(6)}<br>
                Lng: ${lng.toFixed(6)}`;
            
            if (heading !== undefined && heading !== null) {
                popupContent += `<br>Heading: ${heading.toFixed(1)}Â°`;
            }
            
            popupContent += '</div>';
            roverMarker.bindPopup(popupContent);
            if (autoFollow) {
                map.setView([lat, lng], map.getZoom());
            }
            
            console.log(`Rover position updated: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
        }
        
        // Function to center map on rover
        function centerOnRover() {
            if (roverMarker) {
                map.setView(roverMarker.getLatLng(), map.getZoom());
                roverMarker.openPopup();
            }
        }
        
        // Function to fit map to show all waypoints and rover
        function fitMapToContent() {
            var group = new L.featureGroup();
            
            // Add all waypoint markers to group
            waypointMarkers.forEach(function(marker) {
                group.addLayer(marker);
            });
            
            // Add rover marker if it exists
            if (roverMarker) {
                group.addLayer(roverMarker);
            }
            
            // Fit map to show all markers
            if (group.getLayers().length > 0) {
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        // Function to set map view (called from Python)
        function setMapView(lat, lng, zoom) {
            map.setView([lat, lng], zoom || 13);
        }

        function setAutoFollow(enabled) { autoFollow = !!enabled; }

        // Fit to planned mission path (called from Python)
        function fitMissionPath(pathPoints) {
            if (!pathPoints || pathPoints.length === 0) return;
            var latlngs = pathPoints.map(function(p){ return L.latLng(p[0], p[1]); });
            var bounds = L.latLngBounds(latlngs);
            map.fitBounds(bounds.pad(0.1));
        }

        // Wire control bar buttons
        document.getElementById('btnCenter').addEventListener('click', centerOnRover);
        document.getElementById('btnFit').addEventListener('click', fitMapToContent);
        document.getElementById('btnFollow').addEventListener('click', function(){ setAutoFollow(true); centerOnRover(); });
        
        // Log when map is ready
        console.log('ESP32 Rover map initialized and ready');
    </script>
</body>
</html>
